default:
  tags:
    - k8s

variables:
  DOCKER_IMAGE: "us-docker.pkg.dev/inspira-registry/docker/data/crawlers"

stages:
  - build
  - deploy
  - release

.configure-gcloud: &configure-gcloud
  - echo $GCP_SERVICE_KEY > gcloud-service-key.json # Google Cloud service accounts
  - gcloud auth activate-service-account --key-file gcloud-service-key.json

build:
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  stage: build
  variables:
    GOOGLE_APPLICATION_CREDENTIALS: gcloud-service-key.json
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
  before_script:
    - echo $GCP_SERVICE_KEY > gcloud-service-key.json
  script:
    - /kaniko/executor
      --log-format text
      --context "${CI_PROJECT_DIR}"
      --cache
      --cache-copy-layers
      --destination "${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA}"

retag:
  stage: deploy
  image: google/cloud-sdk
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        CR_DOCKER_FROM_TAG: $CI_COMMIT_SHORT_SHA
        CR_DOCKER_TAG: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        CR_DOCKER_FROM_TAG: $CI_COMMIT_SHORT_SHA
        CR_DOCKER_TAG: latest
  before_script:
    - *configure-gcloud
  script:
    - gcloud container images add-tag ${DOCKER_IMAGE}:${CR_DOCKER_FROM_TAG} ${DOCKER_IMAGE}:${CR_DOCKER_TAG}

# ------------------
# RELEASE
# ------------------
release:
  image: $CI_REGISTRY/inspiralegal/gitlabci-docker-images/semantic-release:latest
  stage: release
  script:
    - semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
